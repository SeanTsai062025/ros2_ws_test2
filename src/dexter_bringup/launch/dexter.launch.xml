<launch>

  <!-- ════════════════════════════════════════════════════════════════════
       Arguments
       ════════════════════════════════════════════════════════════════════ -->
  <arg name="use_hardware" default="false"
       description="true = launch hardware bridge with real CAN; false = sim only" />
  <arg name="use_sim" default="false"
       description="hardware bridge sim mode (no CAN, fake positions)" />
  <arg name="can_interface" default="can0" />
  <arg name="can_bitrate" default="500000" />

  <let name="urdf_path"
       value="$(find-pkg-share dexter_moveit_config)/config/dexter_simplify.urdf.xacro"/>
  <let name="rviz_config_path"
    value="$(find-pkg-share dexter_bringup)/config/dexter_moveit.rviz"/>

  <!-- ════════════════════════════════════════════════════════════════════
       Core ros2_control stack (mock hardware for JTC + RViz)
       ════════════════════════════════════════════════════════════════════ -->
  <node pkg="robot_state_publisher" exec="robot_state_publisher">
    <param name="robot_description"
           value="$(command 'xacro $(var urdf_path)')" />
  </node>

  <node pkg="controller_manager" exec="ros2_control_node">
    <param name="robot_description"
           value="$(command 'xacro $(var urdf_path)')" />
    <param from="$(find-pkg-share dexter_bringup)/config/ros2_controllers.yaml" />
  </node>

  <node pkg="controller_manager" exec="spawner" args="joint_state_broadcaster" />
  <node pkg="controller_manager" exec="spawner" args="arm_controller" />

  <!-- ════════════════════════════════════════════════════════════════════
       MoveIt move_group
       ════════════════════════════════════════════════════════════════════ -->
  <include file="$(find-pkg-share dexter_moveit_config)/launch/move_group.launch.py" />

  <!-- ════════════════════════════════════════════════════════════════════
       RViz
       ════════════════════════════════════════════════════════════════════ -->
  <node pkg="rviz2" exec="rviz2" output="screen"
        args="-d $(var rviz_config_path)" />

  <!-- ════════════════════════════════════════════════════════════════════
       Hardware Bridge v3 — Plan C (0xFE position streaming at 30 Hz)
       Launched only when use_hardware:=true
       Subscribes to /arm_controller/controller_state from JTC
       Publishes  /encoder_joint_states from real encoders
       ════════════════════════════════════════════════════════════════════ -->
  <group if="$(var use_hardware)">
    <node pkg="dexter_hardware" exec="dexter_hardware_bridge.py"
          name="dexter_hardware_bridge" output="screen">
      <param name="can_interface" value="$(var can_interface)" />
      <param name="can_bitrate"   value="$(var can_bitrate)" />
      <param name="control_rate"  value="100.0" />
      <param name="bus_rate"      value="30.0" />
      <param name="use_sim"       value="$(var use_sim)" />
    </node>
  </group>

</launch>
